name: Validate Script Sync

on:
  push:
    branches: [main]
    paths:
      - 'scripts/*.py'
      - 'k8s/platform/**/configmap.yaml'
      - 'k8s/platform/**/*-configmap.yaml'
  pull_request:
    paths:
      - 'scripts/*.py'
      - 'k8s/platform/**/configmap.yaml'
      - 'k8s/platform/**/*-configmap.yaml'

jobs:
  validate-script-sync:
    name: Validate Script Sync
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v4.3.1

      - name: Validate Python syntax
        run: |
          echo "Validating Python script syntax..."
          python3 -m py_compile scripts/*.py
          echo "All Python scripts have valid syntax"

      - name: Regenerate ConfigMaps
        run: |
          chmod +x scripts/generate-configmaps.sh
          ./scripts/generate-configmaps.sh

      - name: Check for differences
        run: |
          if ! git diff --exit-code; then
            echo ""
            echo "=============================================="
            echo "ERROR: ConfigMaps are out of sync with scripts"
            echo "=============================================="
            echo ""
            echo "The embedded scripts in ConfigMaps do not match"
            echo "the source files in scripts/ directory."
            echo ""
            echo "To fix this, run:"
            echo "  ./scripts/generate-configmaps.sh"
            echo ""
            echo "Then commit the updated ConfigMap files."
            echo ""
            exit 1
          fi

          echo "All ConfigMaps are in sync with source scripts"
