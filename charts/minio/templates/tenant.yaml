{{- if .Values.enabled }}
{{- $secretName := include "minio.secretName" . }}
{{- $existingSecret := lookup "v1" "Secret" .Release.Namespace $secretName }}
{{- $accessKey := "" }}
{{- $secretKey := "" }}
{{- if and $existingSecret $existingSecret.data (index $existingSecret.data "accesskey") (index $existingSecret.data "secretkey") }}
{{- $accessKey = index $existingSecret.data "accesskey" | b64dec }}
{{- $secretKey = index $existingSecret.data "secretkey" | b64dec }}
{{- else }}
{{- $accessKey = randAlphaNum 20 }}
{{- $secretKey = randAlphaNum 40 }}
{{- end }}
---
# Secret for MinIO credentials
# Uses lookup to preserve existing credentials on helm upgrade
# Format compatible with MinIO Operator v5+
apiVersion: v1
kind: Secret
metadata:
  name: {{ $secretName }}
  labels:
    {{- include "minio.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Keys for application use
  accesskey: {{ $accessKey | quote }}
  secretkey: {{ $secretKey | quote }}
  # Config.env format required by MinIO Operator v5+
  # Values must NOT be quoted per MinIO documentation
  config.env: |
    export MINIO_ROOT_USER={{ $accessKey }}
    export MINIO_ROOT_PASSWORD={{ $secretKey }}
---
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: {{ include "minio.fullname" . }}
  labels:
    {{- include "minio.labels" . | nindent 4 }}
spec:
  # Image configuration
  image: quay.io/minio/minio:{{ .Chart.AppVersion }}
  imagePullPolicy: IfNotPresent

  # Credential configuration (references config.env in secret)
  configuration:
    name: {{ $secretName }}

  # Pool configuration (single pool for ephemeral environments)
  pools:
    - servers: {{ .Values.servers | default 1 }}
      name: pool-0
      volumesPerServer: {{ .Values.volumesPerServer | default 1 }}
      volumeClaimTemplate:
        metadata:
          name: data
        spec:
          accessModes:
            - ReadWriteOnce
          {{- if .Values.storage.storageClass }}
          storageClassName: {{ .Values.storage.storageClass }}
          {{- end }}
          resources:
            requests:
              storage: {{ .Values.storage.size | default "1Gi" }}
      resources:
        requests:
          memory: {{ .Values.resources.requests.memory | default "256Mi" }}
          cpu: {{ .Values.resources.requests.cpu | default "100m" }}
        limits:
          memory: {{ .Values.resources.limits.memory | default "512Mi" }}
          cpu: {{ .Values.resources.limits.cpu | default "500m" }}
      {{- with .Values.securityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.containerSecurityContext }}
      containerSecurityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}

  # Disable TLS for simplicity in ephemeral environments
  requestAutoCert: false

  # Prometheus integration (disabled for ephemeral environments)
  prometheusOperator: false

  # Buckets to create
  buckets:
    - name: {{ .Values.bucket | default "data" }}
{{- end }}
