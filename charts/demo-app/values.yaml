# Image configuration
image:
  repository: ghcr.io/genesluna/k8s-ephemeral-environments/demo-app
  tag: latest
  # Digest for immutable image reference (preferred over tag for security)
  # When set, takes precedence over tag
  digest: ""
  # Always pull for mutable tags (pr-X) to ensure latest image
  pullPolicy: Always

# Image pull secrets for private registries
imagePullSecrets: []
# - name: ghcr-secret

# PR-specific configuration (overridden by workflow)
# projectId: Unique identifier for this project in multi-tenant clusters
projectId: "k8s-ee"
prNumber: ""
commitSha: ""
branchName: ""
previewDomain: "k8s-ee.genesluna.dev"

# Application configuration
app:
  port: 3000
  logLevel: info

# Resource configuration (fits within LimitRange)
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 200m
    memory: 384Mi

# Liveness probe
livenessProbe:
  httpGet:
    path: /api/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# Readiness probe
readinessProbe:
  httpGet:
    path: /api/health
    port: http
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

# Startup probe (prevents liveness from killing slow-starting pods)
startupProbe:
  httpGet:
    path: /api/health
    port: http
  initialDelaySeconds: 5
  failureThreshold: 30
  periodSeconds: 2

# Graceful shutdown configuration
# Allow time for load balancer to drain connections before terminating
terminationGracePeriodSeconds: 30

# Priority class for scheduling (lower than platform components)
priorityClassName: default-app

# Lifecycle hooks for graceful shutdown
lifecycle:
  preStop:
    exec:
      # Sleep allows in-flight requests to complete and load balancer to remove pod
      command: ["/bin/sh", "-c", "sleep 5"]

# Ingress configuration
ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.tls.certresolver: letsencrypt-prod

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 1001
  runAsGroup: 1001
  fsGroup: 1001

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Prometheus metrics configuration
metrics:
  enabled: true
  # Scrape interval
  interval: 30s
  # Scrape timeout
  scrapeTimeout: 10s

# PostgreSQL database configuration (uses library chart)
postgresql:
  enabled: true
  instances: 1
  version: "16"
  database: app
  owner: app
  storage:
    size: 1Gi
  resources:
    requests:
      memory: 256Mi
      cpu: 100m
    limits:
      memory: 512Mi
      cpu: 500m
  # Bootstrap configuration with init SQL for test_records table
  # See demo-app/migrations/001_create_test_records.sql for documented version
  # Note: postInitApplicationSQL runs AFTER the app database is created
  bootstrap:
    postInitApplicationSQL:
      - |
        -- Test records table for observability testing
        CREATE TABLE IF NOT EXISTS test_records (
          id SERIAL PRIMARY KEY,
          name VARCHAR(255) NOT NULL,
          data JSONB DEFAULT '{}',
          created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
          updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
        );
        CREATE INDEX IF NOT EXISTS idx_test_records_created_at ON test_records(created_at DESC);
        CREATE INDEX IF NOT EXISTS idx_test_records_name ON test_records(name);
        -- Function to update updated_at timestamp
        CREATE OR REPLACE FUNCTION update_updated_at_column()
        RETURNS TRIGGER AS $func$
        BEGIN
          NEW.updated_at = NOW();
          RETURN NEW;
        END;
        $func$ language 'plpgsql';
        -- Trigger to automatically update updated_at
        DROP TRIGGER IF EXISTS update_test_records_updated_at ON test_records;
        CREATE TRIGGER update_test_records_updated_at
          BEFORE UPDATE ON test_records
          FOR EACH ROW
          EXECUTE FUNCTION update_updated_at_column();
        -- Grant permissions to app user (bootstrap runs as postgres superuser)
        GRANT ALL PRIVILEGES ON test_records TO app;
        GRANT USAGE, SELECT ON SEQUENCE test_records_id_seq TO app;

# MongoDB configuration (uses library chart)
# Enable for applications requiring MongoDB
mongodb:
  enabled: false

# Redis configuration (uses library chart)
# Enable for applications requiring Redis caching
redis:
  enabled: false

# MinIO configuration (uses library chart)
# Enable for applications requiring S3-compatible storage
minio:
  enabled: false
