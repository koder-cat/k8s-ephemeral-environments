# Tasks for US-010: Secure Database Credentials Management

## Overview

This story ensures database credentials are securely managed through operator-generated secrets and standardized environment variable injection via library chart templates.

## Tasks

### T-010.1: Define Standard Environment Variable Conventions
- **Description:** Document standardized env var names for all database types
- **Acceptance Criteria:**
  - `DATABASE_URL` for PostgreSQL/MySQL (connection URI)
  - `MONGODB_URI` for MongoDB (connection string)
  - `REDIS_URL` for Redis
  - `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY` for MinIO
  - Conventions documented in user story and guides
- **Estimate:** XS

### T-010.2: Implement PostgreSQL envVars Template
- **Description:** Create Helm template for PostgreSQL credential injection
- **Acceptance Criteria:**
  - Template at `charts/postgresql/templates/_helpers.tpl`
  - Named template `postgresql.envVars` outputs env vars
  - Reads from CloudNativePG auto-generated secret
  - Includes `DATABASE_URL` with full connection URI
- **Estimate:** S

### T-010.3: Implement MongoDB envVars Template
- **Description:** Create Helm template for MongoDB credential injection
- **Acceptance Criteria:**
  - Template at `charts/mongodb/templates/_helpers.tpl`
  - Named template `mongodb.envVars` outputs env vars
  - Reads from MongoDB operator auto-generated secret
  - Includes `MONGODB_URI` with connection string
- **Estimate:** S

### T-010.4: Implement MinIO envVars Template
- **Description:** Create Helm template for MinIO credential injection
- **Acceptance Criteria:**
  - Template at `charts/minio/templates/_helpers.tpl`
  - Named template `minio.envVars` outputs env vars
  - Reads from MinIO operator auto-generated secret
  - Includes `S3_ENDPOINT`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`
- **Estimate:** S

### T-010.5: Implement Redis envVars Template
- **Description:** Create Helm template for Redis credential injection
- **Acceptance Criteria:**
  - Template at `charts/redis/templates/_helpers.tpl`
  - Named template `redis.envVars` outputs env vars
  - Reads from Redis secret (generated by chart)
  - Includes `REDIS_URL` with connection string
- **Estimate:** S

### T-010.6: Update Demo-App to Use Credentials
- **Description:** Configure demo-app to read database credentials from environment
- **Acceptance Criteria:**
  - Demo-app deployment includes `{{ include "postgresql.envVars" . }}`
  - Application code connects using `DATABASE_URL`
  - No hardcoded credentials in code or config
  - Health check includes database connectivity test
- **Estimate:** S

### T-010.7: Verify Secret Cleanup
- **Description:** Ensure secrets are deleted with namespace
- **Acceptance Criteria:**
  - Close a PR with database enabled
  - Verify all secrets deleted (operator-generated and chart-generated)
  - No orphaned secrets remain in cluster
  - Document cleanup behavior
- **Estimate:** XS

### T-010.8: Document Credential Access Patterns
- **Description:** Document how projects access database credentials
- **Acceptance Criteria:**
  - Guide section on credential injection
  - Examples for each database type
  - Troubleshooting for common issues
  - Security best practices
- **Estimate:** S

---

## Estimate Legend
- **XS:** < 1 hour
- **S:** 1-4 hours
- **M:** 4-8 hours (1 day)
- **L:** 2-3 days
- **XL:** 4-5 days

## Notes

### Operator-Generated Secrets

Each database operator generates secrets automatically:

| Operator | Secret Pattern | Generated Fields |
|----------|---------------|------------------|
| CloudNativePG | `{cluster}-app` | `host`, `port`, `dbname`, `user`, `password`, `uri` |
| MongoDB | `{name}-admin-{user}` | `connectionString.standard`, `password` |
| MinIO | `{tenant}-secret` | `accesskey`, `secretkey` |

### Security Considerations

- Secrets live only in the PR namespace
- Namespace deletion cascades to all secrets
- No secrets committed to git
- Operators use cryptographically secure random passwords
- Future enhancement: Sealed Secrets for any static secrets needed
